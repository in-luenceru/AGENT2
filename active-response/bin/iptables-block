#!/bin/bash
# Advanced IP blocking with iptables
# Usage: iptables-block <action> <ip> <timeout>

LOCAL=$(dirname $0)
cd $LOCAL
cd ../

# Log configuration
LOG_FILE="/workspaces/AGENT2/logs/active-response.log"
PWD=$(pwd)

# Validate action
ACTION="$1"
IP="$2"
TIMEOUT="$3"

# Validate IP address
if ! echo "$IP" | grep -qE '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$'; then
    echo "$(date '+%Y/%m/%d %H:%M:%S') [ERROR] Invalid IP address: $IP" >> $LOG_FILE
    exit 1
fi

# Block function
block_ip() {
    echo "$(date '+%Y/%m/%d %H:%M:%S') [INFO] Blocking IP: $IP for ${TIMEOUT}s" >> $LOG_FILE
    
    # Create custom chain if not exists
    iptables -L WAZUH_BLOCK >/dev/null 2>&1 || iptables -N WAZUH_BLOCK
    
    # Insert rule to block IP
    iptables -I WAZUH_BLOCK -s $IP -j DROP
    iptables -I INPUT -j WAZUH_BLOCK
    
    # Store blocked IP for tracking
    echo "$IP:$(date +%s):$TIMEOUT" >> /tmp/wazuh_blocked_ips.txt
    
    echo "$(date '+%Y/%m/%d %H:%M:%S') [SUCCESS] IP $IP blocked successfully" >> $LOG_FILE
}

# Unblock function
unblock_ip() {
    echo "$(date '+%Y/%m/%d %H:%M:%S') [INFO] Unblocking IP: $IP" >> $LOG_FILE
    
    # Remove IP from chain
    iptables -D WAZUH_BLOCK -s $IP -j DROP 2>/dev/null
    
    # Remove from tracking file
    grep -v "^$IP:" /tmp/wazuh_blocked_ips.txt > /tmp/wazuh_blocked_ips.tmp 2>/dev/null
    mv /tmp/wazuh_blocked_ips.tmp /tmp/wazuh_blocked_ips.txt 2>/dev/null
    
    echo "$(date '+%Y/%m/%d %H:%M:%S') [SUCCESS] IP $IP unblocked successfully" >> $LOG_FILE
}

# Check if IP is private/local
is_private_ip() {
    echo "$IP" | grep -qE '^(192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[01])\.|127\.)'
}

# Main logic
case "$ACTION" in
    add)
        if is_private_ip; then
            echo "$(date '+%Y/%m/%d %H:%M:%S') [WARNING] Skipping private IP: $IP" >> $LOG_FILE
        else
            block_ip
            
            # Schedule automatic unblock if timeout specified
            if [ -n "$TIMEOUT" ] && [ "$TIMEOUT" -gt 0 ]; then
                (sleep $TIMEOUT && $0 delete $IP) &
            fi
        fi
        ;;
    delete)
        unblock_ip
        ;;
    *)
        echo "$(date '+%Y/%m/%d %H:%M:%S') [ERROR] Invalid action: $ACTION" >> $LOG_FILE
        exit 1
        ;;
esac

exit 0