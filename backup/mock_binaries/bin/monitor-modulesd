#!/bin/bash
# Real Modules Daemon - Wrapper for wazuh-modulesd

WAZUH_HOME="${WAZUH_HOME:-$(dirname $(dirname $(realpath $0)))}"
PID_DIR="$WAZUH_HOME/var/run"
mkdir -p "$PID_DIR"

# Use system binary first since it's more stable for modulesd
if [[ -f "/var/ossec/bin/wazuh-modulesd" ]]; then
    MODULESD_BIN="/var/ossec/bin/wazuh-modulesd"
    # Copy our config to system location for modulesd
    sudo cp "$WAZUH_HOME/etc/ossec.conf" "/var/ossec/etc/ossec.conf" 2>/dev/null || true
elif [[ -f "$WAZUH_HOME/src/wazuh-modulesd" ]]; then
    MODULESD_BIN="$WAZUH_HOME/src/wazuh-modulesd"
else
    echo "[$(date)] ERROR: No wazuh-modulesd binary found"
    exit 1
fi

echo "[$(date)] monitor-modulesd: Starting real modules daemon"
echo "[$(date)] monitor-modulesd: Using binary: $MODULESD_BIN"

# Set environment
export WAZUH_HOME="$WAZUH_HOME"
export LD_LIBRARY_PATH="$WAZUH_HOME/src:$WAZUH_HOME/src/syscheckd/build/lib:$WAZUH_HOME/src/shared_modules/sync_protocol/build/lib:$WAZUH_HOME/src/wazuh_modules/sca/build/lib:$WAZUH_HOME/src/wazuh_modules/syscollector/build/lib:$WAZUH_HOME/src/shared_modules/dbsync/build/lib:$WAZUH_HOME/src/data_provider/build/lib:$WAZUH_HOME/src/external/libdb/build_unix/.libs:$LD_LIBRARY_PATH"

# Start the real modules daemon
exec "$MODULESD_BIN" "$@"
