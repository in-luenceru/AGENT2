#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AGENT_HOME="$(dirname "$SCRIPT_DIR")"
LOG_FILE="$AGENT_HOME/logs/ossec.log"
PID_FILE="$AGENT_HOME/var/run/monitor-execd.pid"

echo $$ > "$PID_FILE"

log_message() {
    echo "[$(date '+%Y/%m/%d %H:%M:%S')] wazuh-execd: $1" >> "$LOG_FILE"
    echo "[$(date '+%Y/%m/%d %H:%M:%S')] wazuh-execd: $1"
}

cleanup() {
    log_message "Shutting down active response daemon"
    rm -f "$PID_FILE"
    exit 0
}

trap cleanup SIGTERM SIGINT

log_message "Starting active response daemon"

while true; do
    # Check for active response commands
    if [[ -f "$AGENT_HOME/queue/ar/ar-execd" ]]; then
        log_message "Processing active response command"
        # Process the command here
        rm -f "$AGENT_HOME/queue/ar/ar-execd"
    fi
    
    sleep 10
done
