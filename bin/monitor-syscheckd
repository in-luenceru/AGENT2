#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AGENT_HOME="$(dirname "$SCRIPT_DIR")"
LOG_FILE="$AGENT_HOME/logs/ossec.log"
PID_FILE="$AGENT_HOME/var/run/monitor-syscheckd.pid"

echo $$ > "$PID_FILE"

log_message() {
    echo "[$(date '+%Y/%m/%d %H:%M:%S')] wazuh-syscheckd: $1" >> "$LOG_FILE"
    echo "[$(date '+%Y/%m/%d %H:%M:%S')] wazuh-syscheckd: $1"
}

cleanup() {
    log_message "Shutting down file integrity monitor"
    rm -f "$PID_FILE"
    exit 0
}

trap cleanup SIGTERM SIGINT

log_message "Starting file integrity monitoring"

while true; do
    # Check key system directories
    for dir in /etc /usr/bin /usr/sbin /bin /sbin; do
        if [[ -d "$dir" ]]; then
            local changes=$(find "$dir" -newer "$PID_FILE" -type f 2>/dev/null | wc -l)
            if [[ $changes -gt 0 ]]; then
                log_message "FIM ALERT: $changes file changes detected in $dir"
            fi
        fi
    done
    
    sleep 300  # Check every 5 minutes
done
